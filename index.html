<!DOCTYPE html>
<html>
<head>
  <title>Torre Control Comercial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family: Arial; display:flex; }
    #map { flex: 3; height:100vh; }
    #panel {
      flex:1;
      background:#f4f4f4;
      padding:15px;
      overflow-y:auto;
      border-left:1px solid #ccc;
    }
    button { padding:8px; margin-bottom:10px; width:100%; }
    .card {
      background:white;
      padding:10px;
      margin-bottom:10px;
      border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>

<body>

<div id="map"></div>

<div id="panel">
  <h3>ðŸš€ Torre de Control</h3>
  <button onclick="startTracking()">Iniciar seguimiento</button>
  <button onclick="stopTracking()">Detener seguimiento</button>
  <p id="status">Estado: Esperando...</p>
  <hr>
  <div id="devices"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwgCjC6tC56l1xEGHwW3vzXtLM2nXR7ck&libraries=geometry"></script>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyBQw9PUFPMny8jAHnjEAjnQS7Qo8dvEIfw",
  authDomain: "torrecontrolmvp.firebaseapp.com",
  projectId: "torrecontrolmvp"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let map;
let markers = {};
let polylines = {};
let deviceColors = {};
let distances = {};
let lastPoints = {};
let deviceNames = {};
let watchId = null;

const MIN_DISTANCE_METERS = 5;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center:{lat:0,lng:0},
    zoom:2
  });
}

function generateColorFromId(id) {
  let hash=0;
  for(let i=0;i<id.length;i++){
    hash=id.charCodeAt(i)+((hash<<5)-hash);
  }
  return "#"+((hash>>24)&0xFF).toString(16).padStart(2,"0")
           +((hash>>16)&0xFF).toString(16).padStart(2,"0")
           +((hash>>8)&0xFF).toString(16).padStart(2,"0");
}

window.onload=function(){
  initMap();
  const today=new Date().toISOString().split("T")[0];

  db.collection("locations").onSnapshot(snapshot=>{

    if(snapshot.empty) return;

    const bounds = new google.maps.LatLngBounds();
    let activeUsers = 0;

    snapshot.forEach(doc=>{
      const data=doc.data();
      const pos={lat:data.lat,lng:data.lng};

      activeUsers++;
      bounds.extend(pos);

      deviceNames[doc.id] = data.user || "User";

      if(!deviceColors[doc.id])
        deviceColors[doc.id]=generateColorFromId(doc.id);

      const color=deviceColors[doc.id];

      if(markers[doc.id]){
        markers[doc.id].setPosition(pos);
      }else{
        markers[doc.id]=new google.maps.Marker({
          position:pos,
          map:map,
          title:data.user,
          label:{
            text:data.user || "User",
            fontSize:"12px",
            fontWeight:"bold"
          },
          icon:{
            path:google.maps.SymbolPath.CIRCLE,
            scale:8,
            fillColor:color,
            fillOpacity:1,
            strokeWeight:1
          }
        });
      }

      if(!polylines[doc.id]){
        db.collection("routes")
        .doc(doc.id)
        .collection(today)
        .orderBy("timestamp")
        .onSnapshot(routeSnap=>{
          let path=[];
          let total=0;
          let prev=null;

          routeSnap.forEach(p=>{
            const pt=p.data();
            path.push({lat:pt.lat,lng:pt.lng});
            if(prev){
              total+=google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(prev.lat,prev.lng),
                new google.maps.LatLng(pt.lat,pt.lng)
              );
            }
            prev=pt;
          });

          distances[doc.id]=total/1000;

          if(polylines[doc.id]){
            polylines[doc.id].setPath(path);
          }else{
            polylines[doc.id]=new google.maps.Polyline({
              path:path,
              strokeColor:color,
              strokeWeight:3,
              map:map
            });
          }

          updatePanel();
        });
      }

    });

    // ZOOM INTELIGENTE
    if(activeUsers === 1){
      map.fitBounds(bounds);
      setTimeout(()=> map.setZoom(18), 300);
    } else if(activeUsers > 1){
      map.fitBounds(bounds);
    }

  });
};

function updatePanel(){
  const container=document.getElementById("devices");
  container.innerHTML="";
  for(let id in distances){
    container.innerHTML+=`
      <div class="card">
        <b>${deviceNames[id] || id.substring(0,6)}</b><br>
        Distancia hoy: ${distances[id].toFixed(2)} km
      </div>`;
  }
}

function startTracking(){
  const deviceId=localStorage.getItem("deviceId")||crypto.randomUUID();
  localStorage.setItem("deviceId",deviceId);

  let userName=localStorage.getItem("userName");
  if(!userName){
    userName=prompt("Ingrese nombre del usuario:");
    localStorage.setItem("userName",userName);
  }

  const today=new Date().toISOString().split("T")[0];

  watchId=navigator.geolocation.watchPosition(async pos=>{
        
    const lat=pos.coords.latitude;
    const lng=pos.coords.longitude;
    const now=new Date();

    if(lastPoints[deviceId]){
      const dist=google.maps.geometry.spherical.computeDistanceBetween(
        new google.maps.LatLng(lastPoints[deviceId].lat,lastPoints[deviceId].lng),
        new google.maps.LatLng(lat,lng)
      );
      if(dist<MIN_DISTANCE_METERS)return;
    }

    lastPoints[deviceId]={lat,lng};

    await db.collection("routes")
      .doc(deviceId)
      .collection(today)
      .add({lat,lng,timestamp:now});

    await db.collection("locations")
      .doc(deviceId)
      .set({lat,lng,timestamp:now,user:userName});
  },
  error=>{
    alert("Error obteniendo ubicaciÃ³n: " + error.message);
  },
  { enableHighAccuracy:true });
}

function stopTracking(){
  if(watchId){
    navigator.geolocation.clearWatch(watchId);
    watchId=null;
  }
}

</script>

</body>
</html>



