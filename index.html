<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBQw9PUFPMny8jAHnjEAjnQS7Qo8dvEIfw",
    authDomain: "torrecontrolmvp.firebaseapp.com",
    projectId: "torrecontrolmvp",
    storageBucket: "torrecontrolmvp.firebasestorage.app",
    messagingSenderId: "1091567628359",
    appId: "1:1091567628359:web:327f4938ecbe2622aac162"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let map = null;
  let markers = {};

  // üî• Crear mapa cuando Google est√© listo
  window.addEventListener("load", function () {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 0, lng: 0 },
      zoom: 2,
    });

    // üî• Listener en tiempo real (dentro de load para asegurar que map existe)
    db.collection("locations").onSnapshot((snapshot) => {

      snapshot.forEach((doc) => {
        const data = doc.data();
        if (!data.lat || !data.lng) return;

        const position = { lat: data.lat, lng: data.lng };

        if (markers[doc.id]) {
          markers[doc.id].setPosition(position);
        } else {
          markers[doc.id] = new google.maps.Marker({
            position: position,
            map: map,
            label: doc.id.substring(0, 4)
          });
        }
      });

    });
  });

  // üî• Funci√≥n del bot√≥n
  function startTracking() {

    const status = document.getElementById("status");
    status.innerText = "Solicitando ubicaci√≥n...";

    if (!navigator.geolocation) {
      status.innerText = "‚ùå Geolocalizaci√≥n no soportada.";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      async (position) => {

        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        const deviceId = localStorage.getItem("deviceId") 
          || crypto.randomUUID();

        localStorage.setItem("deviceId", deviceId);

        await db.collection("locations").doc(deviceId).set({
          lat: lat,
          lng: lng,
          timestamp: new Date()
        });

        status.innerText = `‚úÖ Ubicaci√≥n enviada: ${lat}, ${lng}`;

        if (map) {
          map.setCenter({ lat, lng });
          map.setZoom(15);
        }

      },
      (error) => {
        console.error(error);
        status.innerText = "‚ùå Error obteniendo ubicaci√≥n.";
      },
      {
        enableHighAccuracy: true,
        timeout: 30000
      }
    );
  }
</script>
