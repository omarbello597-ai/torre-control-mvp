<!DOCTYPE html>
<html>
<head>
  <title>Torre Control Comercial - Anal√≠tica Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family: Arial; display:flex; }
    #map { flex: 3; height:100vh; }
    #panel {
      flex:1;
      background:#f4f4f4;
      padding:15px;
      overflow-y:auto;
      border-left:1px solid #ccc;
    }
    button { padding:8px; margin-bottom:8px; width:100%; }
    .card {
      background:white;
      padding:10px;
      margin-bottom:10px;
      border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    h4 { margin-top:20px; }
    #roleIndicator {
      font-weight:bold;
      margin-bottom:10px;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div id="panel">
  <h3>üöÄ Torre de Control</h3>

  <div id="roleIndicator"></div>

  <button onclick="startTracking()">Iniciar seguimiento</button>
  <button onclick="stopTracking()">Detener seguimiento</button>

  <hr>

  <h4>üìä An√°lisis</h4>
  <div id="analysis"></div>

  <button onclick="exportCSV()">Exportar CSV</button>
  <button onclick="exportGeoJSON()">Exportar GeoJSON</button>

  <hr>

  <h4>üë• Usuarios</h4>
  <div id="devices"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwgCjC6tC56l1xEGHwW3vzXtLM2nXR7ck&libraries=geometry,visualization"></script>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyBQw9PUFPMny8jAHnjEAjnQS7Qo8dvEIfw",
  authDomain: "torrecontrolmvp.firebaseapp.com",
  projectId: "torrecontrolmvp"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let map;
let markers = {};
let polylines = {};
let heatmap;
let distances = {};
let lastPoints = {};
let heatPoints = [];
let watchId = null;

let userRole = null;
let currentUserId = null;

const MIN_DISTANCE_METERS = 5;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center:{lat:4.6,lng:-74.1},
    zoom:6
  });
}

window.onload = function(){
  initMap();
  loadRole();
  listenLocations();
};

function loadRole(){
  userRole = localStorage.getItem("role");
  currentUserId = localStorage.getItem("deviceId");

  if(!userRole){
    userRole = "user";
  }

  document.getElementById("roleIndicator").innerHTML =
    userRole === "master" ? "üëë MASTER ACTIVO" : "üë§ Modo Usuario";
}

function startTracking(){

  currentUserId = localStorage.getItem("deviceId") || crypto.randomUUID();
  localStorage.setItem("deviceId", currentUserId);

  let savedRole = localStorage.getItem("role");

  if(!savedRole){
    const key = prompt("Ingrese KEY MASTER si aplica o deje vac√≠o:");

    if(key === "MASTER2026"){
      userRole = "master";
    } else {
      userRole = "user";
    }

    localStorage.setItem("role", userRole);
  } else {
    userRole = savedRole;
  }

  loadRole();

  const userName = prompt("Nombre usuario:");
  const today = new Date().toISOString().split("T")[0];

  watchId = navigator.geolocation.watchPosition(async pos => {

    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const now = new Date();

    if(lastPoints[currentUserId]){
      const dist = google.maps.geometry.spherical.computeDistanceBetween(
        new google.maps.LatLng(lastPoints[currentUserId].lat,lastPoints[currentUserId].lng),
        new google.maps.LatLng(lat,lng)
      );
      if(dist < MIN_DISTANCE_METERS) return;
    }

    lastPoints[currentUserId] = {lat,lng};

    await db.collection("routes")
      .doc(currentUserId)
      .collection(today)
      .add({lat,lng,timestamp:now});

    await db.collection("locations")
      .doc(currentUserId)
      .set({
        lat,
        lng,
        user:userName,
        timestamp:now
      });

  },
  error => alert(error.message),
  { enableHighAccuracy:true });

}

function stopTracking(){
  if(watchId){
    navigator.geolocation.clearWatch(watchId);
    watchId=null;
  }
}

function listenLocations(){

  const today = new Date().toISOString().split("T")[0];

  db.collection("locations").onSnapshot(snapshot=>{

    const bounds = new google.maps.LatLngBounds();
    heatPoints = [];

    snapshot.forEach(doc=>{

      if(userRole !== "master" && doc.id !== currentUserId){
        return;
      }

      const data = doc.data();
      const pos = {lat:data.lat,lng:data.lng};

      bounds.extend(pos);
      heatPoints.push(new google.maps.LatLng(data.lat,data.lng));

      if(markers[doc.id]){
        markers[doc.id].setPosition(pos);
      } else {
        markers[doc.id] = new google.maps.Marker({
          position: pos,
          map: map,
          label: data.user
        });
      }

      if(!polylines[doc.id]){
        db.collection("routes")
        .doc(doc.id)
        .collection(today)
        .orderBy("timestamp")
        .onSnapshot(routeSnap=>{

          let path=[];
          let total=0;
          let prev=null;

          routeSnap.forEach(p=>{
            const pt=p.data();
            path.push({lat:pt.lat,lng:pt.lng});

            if(prev){
              total+=google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(prev.lat,prev.lng),
                new google.maps.LatLng(pt.lat,pt.lng)
              );
            }
            prev=pt;
          });

          distances[doc.id]=total/1000;

          if(polylines[doc.id]){
            polylines[doc.id].setPath(path);
          } else {
            polylines[doc.id]=new google.maps.Polyline({
              path:path,
              strokeWeight:3,
              map:map
            });
          }

          updatePanel();
          updateAnalysis();
        });
      }

    });

    if(!snapshot.empty){
      map.fitBounds(bounds);
    }

    updateHeatmap();
  });
}

function updateHeatmap(){
  if(userRole !== "master") return;

  if(heatmap){
    heatmap.setMap(null);
  }

  heatmap = new google.maps.visualization.HeatmapLayer({
    data: heatPoints,
    radius: 30
  });

  heatmap.setMap(map);
}

function updatePanel(){
  const container=document.getElementById("devices");
  container.innerHTML="";

  for(let id in distances){

    if(userRole !== "master" && id !== currentUserId){
      continue;
    }

    container.innerHTML+=`
      <div class="card">
        <b>${id.substring(0,6)}</b><br>
        KM hoy: ${distances[id].toFixed(2)}
      </div>`;
  }
}

function updateAnalysis(){

  if(userRole !== "master"){
    document.getElementById("analysis").innerHTML="Modo usuario activo";
    return;
  }

  let totalGeneral=0;
  let ranking=[];

  for(let id in distances){
    totalGeneral+=distances[id];
    ranking.push({id:id,km:distances[id]});
  }

  ranking.sort((a,b)=>b.km-a.km);

  let html=`Total general: ${totalGeneral.toFixed(2)} km<br>`;
  html+=`Promedio por usuario: ${(totalGeneral/ranking.length || 0).toFixed(2)} km<br><br>`;
  html+=`üèÜ Ranking:<br>`;

  ranking.forEach(r=>{
    html+=`${r.id.substring(0,6)} - ${r.km.toFixed(2)} km<br>`;
  });

  document.getElementById("analysis").innerHTML=html;
}

function exportCSV(){
  if(userRole !== "master"){
    alert("Solo el MASTER puede exportar.");
    return;
  }

  let csv="Usuario,KM\n";
  for(let id in distances){
    csv+=`${id},${distances[id].toFixed(2)}\n`;
  }

  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="reporte_km.csv";
  a.click();
}

function exportGeoJSON(){
  if(userRole !== "master"){
    alert("Solo el MASTER puede exportar.");
    return;
  }

  let features=[];

  for(let id in polylines){

    const path=polylines[id].getPath().getArray();
    let coordinates=[];

    path.forEach(p=>{
      coordinates.push([p.lng(),p.lat()]);
    });

    features.push({
      type:"Feature",
      properties:{
        user:id,
        total_km:distances[id]
      },
      geometry:{
        type:"LineString",
        coordinates:coordinates
      }
    });
  }

  const geojson={
    type:"FeatureCollection",
    features:features
  };

  const blob=new Blob(
    [JSON.stringify(geojson,null,2)],
    {type:"application/geo+json"}
  );

  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="rutas.geojson";
  a.click();
}

</script>

</body>
</html>
