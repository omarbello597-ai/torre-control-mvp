<!DOCTYPE html>
<html>
<head>
  <title>Torre Control GPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: Arial; }
    #map { height: 400px; width: 100%; margin-top: 20px; }
    button { margin-right: 10px; padding: 8px 12px; }
  </style>
</head>

<body>

  <h2>Torre de Control - Seguimiento GPS</h2>
  <button onclick="startTracking()">Iniciar seguimiento</button>
  <button onclick="stopTracking()">Detener seguimiento</button>
  <p id="status"></p>
  <div id="map"></div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwgCjC6tC56l1xEGHwW3vzXtLM2nXR7ck"></script>

  <script>

    const firebaseConfig = {
      apiKey: "AIzaSyBQw9PUFPMny8jAHnjEAjnQS7Qo8dvEIfw",
      authDomain: "torrecontrolmvp.firebaseapp.com",
      projectId: "torrecontrolmvp"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let map;
    let markers = {};
    let polylines = {};
    let watchId = null;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 0, lng: 0 },
        zoom: 2,
      });
    }

    window.onload = function () {
      initMap();

      const today = new Date().toISOString().split("T")[0];

      // Posiciones actuales
      db.collection("locations").onSnapshot(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          const pos = { lat: data.lat, lng: data.lng };

          if (markers[doc.id]) {
            markers[doc.id].setPosition(pos);
          } else {
            markers[doc.id] = new google.maps.Marker({
              position: pos,
              map: map
            });
          }

          // ðŸ”¥ Escuchar histÃ³rico por dispositivo
          db.collection("routes")
            .doc(doc.id)
            .collection(today)
            .orderBy("timestamp")
            .onSnapshot(routeSnap => {

              let path = [];

              routeSnap.forEach(pointDoc => {
                const p = pointDoc.data();
                path.push({ lat: p.lat, lng: p.lng });
              });

              if (polylines[doc.id]) {
                polylines[doc.id].setPath(path);
              } else {
                polylines[doc.id] = new google.maps.Polyline({
                  path: path,
                  geodesic: true,
                  strokeColor: "#FF0000",
                  strokeOpacity: 1.0,
                  strokeWeight: 3,
                  map: map
                });
              }

            });

        });
      });

    };

    function startTracking() {

      if (watchId !== null) return;

      const deviceId = localStorage.getItem("deviceId") 
        || crypto.randomUUID();

      localStorage.setItem("deviceId", deviceId);

      watchId = navigator.geolocation.watchPosition(async position => {

        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const now = new Date();
        const today = now.toISOString().split("T")[0];

        await db.collection("routes")
          .doc(deviceId)
          .collection(today)
          .add({ lat, lng, timestamp: now });

        await db.collection("locations")
          .doc(deviceId)
          .set({ lat, lng, timestamp: now });

      });

    }

    function stopTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
    }

  </script>

</body>
</html>
